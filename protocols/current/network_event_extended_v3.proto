syntax = "proto3";

// âœ… PACKAGE PARA EVENTOS DE RED DISTRIBUIDOS v3.0.0
// ğŸš¨ NUEVA VERSION: Soporte para enriquecimiento GeoIP dual (source + target)
// ğŸ”„ COMPATIBLE: 100% compatible hacia atrÃ¡s con v2
package network.events.distributed;

// Comando para generar cÃ³digo Python:
// protoc --python_out=. network_event_extended_v3.proto

message NetworkEvent {
    // ğŸ” IdentificaciÃ³n del evento
    string event_id = 1;
    int64 timestamp = 2;

    // ğŸŒ InformaciÃ³n de red bÃ¡sica
    string source_ip = 3;
    string target_ip = 4;
    int32 packet_size = 5;
    int32 dest_port = 6;
    int32 src_port = 7;
    string protocol = 8;              // "tcp", "udp", "icmp", etc.

    // ğŸ¤– IdentificaciÃ³n del agente (legacy - mantener compatibilidad)
    string agent_id = 9;

    // ğŸ“Š MÃ©tricas y scoring
    float anomaly_score = 10;
    double latitude = 11;             // ğŸ”„ LEGACY: Coordenadas primarias (compatibilidad)
    double longitude = 12;            // ğŸ”„ LEGACY: Se mantiene para componentes antiguos

    // ğŸ¯ ClasificaciÃ³n de eventos
    string event_type = 13;           // "normal", "suspicious", "tor_detected", etc.
    float risk_score = 14;
    string description = 15;

    // ğŸ–¥ï¸ InformaciÃ³n del sistema operativo
    string so_identifier = 16;        // "linux_ufw", "linux_iptables", "windows_firewall", "darwin_pf"

    // ğŸ  InformaciÃ³n del nodo (handshake inicial)
    string node_hostname = 17;        // Hostname del nodo
    string os_version = 18;           // "Ubuntu 22.04", "Windows 11", etc.
    string firewall_status = 19;      // "active", "inactive", "unknown"
    string agent_version = 20;        // VersiÃ³n del agente
    bool is_initial_handshake = 21;   // true solo en el primer evento del nodo

    // ğŸ†” CAMPOS DISTRIBUIDOS - CRÃTICOS PARA ETCD
    string node_id = 22;              // Identificador Ãºnico asignado por etcd
    int32 process_id = 23;            // PID del proceso dentro del contenedor
    string container_id = 24;         // ID del contenedor (Docker/Podman) - opcional
    string cluster_name = 25;         // Nombre del cluster distribuido - opcional

    // ğŸ”„ Estado del componente distribuido
    string component_status = 26;     // "healthy", "degraded", "initializing"
    int64 uptime_seconds = 27;        // Tiempo de vida del componente

    // ğŸ“ˆ MÃ©tricas de performance del nodo
    int32 queue_depth = 28;           // Profundidad de cola interna
    float cpu_usage_percent = 29;     // Uso de CPU del componente
    float memory_usage_mb = 30;       // Uso de memoria en MB

    // ğŸ”§ ConfiguraciÃ³n dinÃ¡mica
    string config_version = 31;       // VersiÃ³n de configuraciÃ³n aplicada
    int64 config_timestamp = 32;      // Timestamp de Ãºltima actualizaciÃ³n de config

    // ğŸŒ Enriquecimiento GeoIP (LEGACY - compatibilidad v2)
    bool geoip_enriched = 33;         // Indica si ha pasado por enriquecimiento GeoIP
    string enrichment_node = 34;      // node_id del nodo que enriqueciÃ³
    int64 enrichment_timestamp = 35;  // Timestamp del enriquecimiento

    // ğŸ”§ PIDS DE COMPONENTES DISTRIBUIDOS - TRACKING DEL PIPELINE
    int32 promiscuous_pid = 36;       // PID del promiscuous_agent que capturÃ³
    int32 geoip_enricher_pid = 37;    // PID del geoip_enricher que enriqueciÃ³
    int32 ml_detector_pid = 38;       // PID del ml_detector que analizÃ³
    int32 dashboard_pid = 39;         // PID del dashboard que visualizÃ³
    int32 firewall_pid = 40;          // PID del firewall que aplicÃ³ reglas

    // ğŸ“Š TIMESTAMPS DE PROCESAMIENTO POR COMPONENTE
    int64 promiscuous_timestamp = 41;     // Cuando fue capturado
    int64 geoip_enricher_timestamp = 42;  // Cuando fue enriquecido con GeoIP
    int64 ml_detector_timestamp = 43;     // Cuando fue analizado por ML
    int64 dashboard_timestamp = 44;       // Cuando fue mostrado en dashboard
    int64 firewall_timestamp = 45;        // Cuando fue procesado por firewall

    // ğŸ¯ MÃ‰TRICAS DE PIPELINE DISTRIBUIDO
    float processing_latency_ms = 46;     // Latencia total de procesamiento
    int32 pipeline_hops = 47;             // NÃºmero de saltos en el pipeline
    string pipeline_path = 48;            // Ruta del evento: "promiscuous->geoip->ml->dashboard"

    // ğŸ”„ CONTROL DE FLUJO DISTRIBUIDO
    int32 retry_count = 49;               // NÃºmero de reintentos en el pipeline
    string last_error = 50;               // Ãšltimo error encontrado
    bool requires_reprocessing = 51;      // Indica si necesita reprocesamiento

    // ğŸ·ï¸ TAGS Y METADATOS DISTRIBUIDOS
    repeated string component_tags = 52;  // Tags aÃ±adidos por cada componente
    map<string, string> component_metadata = 53; // Metadata adicional por componente

    // ğŸ†• CAMPOS NUEVOS v3.0.0 - ENRIQUECIMIENTO GEOIP DUAL
    // =====================================================

    // ğŸ¯ COORDENADAS DUALES - SEPARADAS PARA SOURCE Y TARGET
    double source_latitude = 54;         // ğŸ  Coordenadas de source_ip (vÃ­ctima/nosotros)
    double source_longitude = 55;        // ğŸ  Longitud de source_ip
    double target_latitude = 56;         // ğŸ¯ Coordenadas de target_ip (atacante)
    double target_longitude = 57;        // ğŸ¯ Longitud de target_ip

    // ğŸŒ INFORMACIÃ“N GEOGRÃFICA RICA
    string source_city = 58;             // ğŸ  Ciudad del source_ip
    string source_country = 59;          // ğŸ  PaÃ­s del source_ip
    string source_country_code = 60;     // ğŸ  CÃ³digo de paÃ­s (ES, US, etc.)
    string source_region = 61;           // ğŸ  RegiÃ³n/estado del source_ip
    string source_timezone = 62;         // ğŸ  Zona horaria del source_ip

    string target_city = 63;             // ğŸ¯ Ciudad del target_ip
    string target_country = 64;          // ğŸ¯ PaÃ­s del target_ip
    string target_country_code = 65;     // ğŸ¯ CÃ³digo de paÃ­s (ES, US, etc.)
    string target_region = 66;           // ğŸ¯ RegiÃ³n/estado del target_ip
    string target_timezone = 67;         // ğŸ¯ Zona horaria del target_ip

    // ğŸ” ESTADO DE ENRIQUECIMIENTO v3.0.0
    bool source_ip_enriched = 68;        // âœ… Si source_ip fue geoposicionada exitosamente
    bool target_ip_enriched = 69;        // âœ… Si target_ip fue geoposicionada exitosamente
    string geoip_primary_source = 70;    // "source" | "target" | "none" - cuÃ¡l se usÃ³ como primaria
    bool dual_enrichment_success = 71;   // âœ… Si ambas IPs fueron enriquecidas exitosamente

    // ğŸŒ DISCOVERY DE IP PÃšBLICA v3.0.0
    bool public_ip_discovered = 72;      // âœ… Si se descubriÃ³ IP pÃºblica para source_ip privada
    string original_source_ip = 73;      // ğŸ“ IP source original antes de discovery (si era privada)
    string discovered_public_ip = 74;    // ğŸŒ IP pÃºblica descubierta (para source_ip privadas)
    string ip_discovery_service = 75;    // ğŸ”— Servicio usado: "api.ipify.org", "ifconfig.me", etc.
    int64 ip_discovery_timestamp = 76;   // â° Timestamp del discovery de IP pÃºblica

    // ğŸ“ ANÃLISIS GEOGRÃFICO v3.0.0
    double geographic_distance_km = 77;  // ğŸ“ Distancia entre source y target en km
    string distance_category = 78;       // ğŸ“Š "local", "regional", "national", "international"
    bool same_country = 79;              // ğŸ³ï¸ Si source y target estÃ¡n en el mismo paÃ­s
    bool same_continent = 80;            // ğŸŒ Si source y target estÃ¡n en el mismo continente

    // ğŸ”§ METADATOS DE ENRIQUECIMIENTO v3.0.0
    string geoip_enricher_version = 81;  // ğŸ“ VersiÃ³n del enricher: "2.1.0", etc.
    string geoip_method = 82;            // ğŸ”§ MÃ©todo usado: "mock", "maxmind", "api", etc.
    bool fallback_coordinates_used = 83; // âš ï¸ Si se usaron coordenadas de fallback
    string geoip_data_source = 84;       // ğŸ“Š Fuente de datos: "GeoLite2", "ipapi", etc.

    // ğŸ¯ ISP Y INFORMACIÃ“N DE RED v3.0.0 (OPCIONAL - para futuras extensiones)
    string source_isp = 85;              // ğŸ¢ ISP del source_ip
    string target_isp = 86;              // ğŸ¢ ISP del target_ip
    string source_asn = 87;              // ğŸ”¢ ASN del source_ip
    string target_asn = 88;              // ğŸ”¢ ASN del target_ip

    // ğŸš¨ INFORMACIÃ“N DE AMENAZAS v3.0.0 (OPCIONAL - para ML detector)
    bool target_is_tor_exit = 89;        // ğŸ” Si target_ip es nodo de salida Tor
    bool target_is_known_malicious = 90; // âš ï¸ Si target_ip estÃ¡ en blacklist conocida
    string threat_intelligence_source = 91; // ğŸ“Š Fuente de intel: "internal", "external", etc.
    float geographic_anomaly_score = 92; // ğŸ“Š Score de anomalÃ­a geogrÃ¡fica (0.0-1.0)

    // ğŸ”„ COMPATIBILIDAD Y VERSIONADO
    string protobuf_schema_version = 93; // ğŸ“ VersiÃ³n del esquema: "v3.0.0"
    bool legacy_compatibility_mode = 94; // ğŸ”„ Si estÃ¡ en modo compatibilidad con v2
    repeated string deprecated_fields = 95; // ğŸ“‹ Campos deprecados que aÃºn se procesan

    // ğŸ“Š MÃ‰TRICAS DE RENDIMIENTO ESPECÃFICAS v3.0.0
    float geoip_lookup_latency_ms = 96;  // â±ï¸ Latencia del lookup GeoIP en ms
    int32 cache_hits_count = 97;         // ğŸ—„ï¸ NÃºmero de cache hits durante enriquecimiento
    int32 cache_misses_count = 98;       // âŒ NÃºmero de cache misses durante enriquecimiento
    float enrichment_success_rate = 99;  // ğŸ“Š Tasa de Ã©xito del enriquecimiento (0.0-1.0)

    // ğŸ·ï¸ RESERVA PARA FUTURAS EXTENSIONES
    // Fields 100-110 reserved for future GeoIP enhancements
    reserved 100 to 110;
    reserved "future_geoip_field_1", "future_geoip_field_2";
}