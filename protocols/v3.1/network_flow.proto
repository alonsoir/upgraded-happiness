// network_security_v3.1.proto
// FECHA CREACIÓN: 8 de agosto de 2025
// DESCRIPCIÓN: Protobuf unificado para sistema tricapa distribuido revolucionario
//
// ARQUITECTURA INNOVADORA:
// - Sistema tricapa con 83+ features unificadas
// - Modo distribuido con cifrado/compresión
// - Time windows + colas para procesamiento
// - GeoIP enrichment + metadatos contextuales
// - RAG + Human-in-the-loop integration
//
// VISIÓN: Sistema distribuido de ciberseguridad ML nunca antes implementado

syntax = "proto3";

package upgraded_happiness.security.v31;

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/any.proto";

// =====================================================================
// CORE DATA STRUCTURES - Features Unificadas
// =====================================================================

message NetworkFeatures {
  // IDENTIFICACIÓN BÁSICA
  string source_ip = 1;
  string destination_ip = 2;
  uint32 source_port = 3;
  uint32 destination_port = 4;
  uint32 protocol = 5;

  // TIMING Y DURACIÓN
  google.protobuf.Timestamp flow_start_time = 6;
  google.protobuf.Duration flow_duration = 7;
  uint64 flow_duration_microseconds = 8;

  // ESTADÍSTICAS DE PAQUETES (Features 1-20)
  uint64 total_fwd_packets = 10;
  uint64 total_backward_packets = 11;
  uint64 total_length_fwd_packets = 12;
  uint64 total_length_bwd_packets = 13;

  // LONGITUDES FORWARD (Features 21-30)
  uint64 fwd_packet_length_max = 20;
  uint64 fwd_packet_length_min = 21;
  double fwd_packet_length_mean = 22;
  double fwd_packet_length_std = 23;

  // LONGITUDES BACKWARD (Features 31-40)
  uint64 bwd_packet_length_max = 30;
  uint64 bwd_packet_length_min = 31;
  double bwd_packet_length_mean = 32;
  double bwd_packet_length_std = 33;

  // VELOCIDADES Y RATIOS (Features 41-50)
  double flow_bytes_s = 40;
  double flow_packets_s = 41;
  double fwd_packets_s = 42;
  double bwd_packets_s = 43;
  double down_up_ratio = 44;
  double average_packet_size = 45;
  double avg_fwd_segment_size = 46;
  double avg_bwd_segment_size = 47;

  // INTER-ARRIVAL TIMES (Features 51-60)
  double flow_iat_mean = 50;
  double flow_iat_std = 51;
  uint64 flow_iat_max = 52;
  uint64 flow_iat_min = 53;
  double fwd_iat_total = 54;
  double fwd_iat_mean = 55;
  double fwd_iat_std = 56;
  uint64 fwd_iat_max = 57;
  uint64 fwd_iat_min = 58;
  double bwd_iat_total = 59;
  double bwd_iat_mean = 60;
  double bwd_iat_std = 61;
  uint64 bwd_iat_max = 62;
  uint64 bwd_iat_min = 63;

  // TCP FLAGS (Features 61-70)
  uint32 fin_flag_count = 65;
  uint32 syn_flag_count = 66;
  uint32 rst_flag_count = 67;
  uint32 psh_flag_count = 68;
  uint32 ack_flag_count = 69;
  uint32 urg_flag_count = 70;
  uint32 cwe_flag_count = 71;
  uint32 ece_flag_count = 72;
  uint32 fwd_psh_flags = 73;
  uint32 bwd_psh_flags = 74;
  uint32 fwd_urg_flags = 75;
  uint32 bwd_urg_flags = 76;

  // HEADERS Y BULK (Features 71-80)
  double fwd_header_length = 77;
  double bwd_header_length = 78;
  double fwd_avg_bytes_bulk = 79;
  double fwd_avg_packets_bulk = 80;
  double fwd_avg_bulk_rate = 81;
  double bwd_avg_bytes_bulk = 82;
  double bwd_avg_packets_bulk = 83;
  double bwd_avg_bulk_rate = 84;

  // FEATURES ADICIONALES TRICAPA (Features 81-83+)
  uint64 min_packet_length = 85;
  uint64 max_packet_length = 86;
  double packet_length_mean = 87;
  double packet_length_std = 88;
  double packet_length_variance = 89;

  // NUEVAS FEATURES INNOVADORAS v3.1
  repeated double custom_ml_features = 100; // Features específicas del modelo
  map<string, double> dynamic_features = 101; // Features dinámicas
}

// =====================================================================
// GEOLOCATION ENRICHMENT - Datos GeoIP
// =====================================================================

message GeoIPInfo {
  string country = 1;
  string country_code = 2;
  string region = 3;
  string city = 4;
  double latitude = 5;
  double longitude = 6;
  string isp = 7;
  string organization = 8;
  string asn = 9;
  string timezone = 10;
  bool is_anonymous_proxy = 11;
  bool is_satellite_provider = 12;
  ThreatLevel threat_level = 13;

  enum ThreatLevel {
    UNKNOWN = 0;
    LOW = 1;
    MEDIUM = 2;
    HIGH = 3;
    CRITICAL = 4;
  }
}

message GeoEnrichment {
  GeoIPInfo source_geo = 1;
  GeoIPInfo destination_geo = 2;
  double geographic_distance_km = 3;
  bool cross_border_communication = 4;
  bool suspicious_geolocation = 5;
  repeated string threat_intelligence_matches = 6;
}

// =====================================================================
// TIME WINDOWS & FLOW AGGREGATION - Sistema de Ventanas
// =====================================================================

message TimeWindow {
  google.protobuf.Timestamp window_start = 1;
  google.protobuf.Timestamp window_end = 2;
  google.protobuf.Duration window_size = 3;
  uint64 sequence_number = 4;
  WindowType type = 5;

  enum WindowType {
    SLIDING = 0;
    TUMBLING = 1;
    SESSION_BASED = 2;
    ADAPTIVE = 3;
  }
}

message FlowAggregation {
  TimeWindow time_window = 1;
  uint64 total_flows = 2;
  uint64 total_packets = 3;
  uint64 total_bytes = 4;
  repeated NetworkFeatures flows = 5;
  map<string, uint64> protocol_distribution = 6;
  map<string, uint64> port_distribution = 7;
  double anomaly_score = 8;
}

// =====================================================================
// MACHINE LEARNING PIPELINE - Tricapa + Modelos
// =====================================================================

message ModelPrediction {
  string model_name = 1;
  string model_version = 2;
  ModelType model_type = 3;
  double confidence = 4;
  string prediction_class = 5;
  repeated double class_probabilities = 6;
  google.protobuf.Timestamp prediction_time = 7;
  google.protobuf.Duration processing_time = 8;

  enum ModelType {
    RANDOM_FOREST = 0;
    LIGHTGBM = 1;
    NEURAL_NETWORK = 2;
    SVM = 3;
    ENSEMBLE = 4;
    TRANSFORMER = 5;
  }
}

message TricapaAnalysis {
  // NIVEL 1 - Filtro General
  ModelPrediction level1_prediction = 1; // CICDS2017
  bool level1_attack_detected = 2;
  double level1_confidence = 3;

  // NIVEL 2 - Especialización Contextual
  ModelPrediction level2_web_prediction = 4;
  ModelPrediction level2_internal_prediction = 5;
  string traffic_context = 6; // "WEB", "INTERNAL", "EXTERNAL"

  // NIVEL 3 - Amenazas Específicas
  repeated ModelPrediction level3_predictions = 7; // DDOS, Ransomware, etc.
  string final_threat_classification = 8;
  double ensemble_confidence = 9;

  // METADATOS DEL ANÁLISIS
  google.protobuf.Duration total_analysis_time = 10;
  repeated string activated_models = 11;
  map<string, double> feature_importance = 12;
}

// =====================================================================
// DISTRIBUTED MODE - Sistema Distribuido
// =====================================================================

message NodeInfo {
  string node_id = 1;
  string node_name = 2;
  string ip_address = 3;
  string location = 4;
  NodeRole role = 5;
  NodeStatus status = 6;
  google.protobuf.Timestamp last_heartbeat = 7;
  map<string, string> capabilities = 8;

  enum NodeRole {
    SNIFFER = 0;        // Captura paquetes
    PROCESSOR = 1;      // Procesa features
    ANALYZER = 2;       // Ejecuta ML
    COORDINATOR = 3;    // Orquesta todo
    STORAGE = 4;        // Almacena datos
    DASHBOARD = 5;      // Visualiza resultados
  }

  enum NodeStatus {
    ACTIVE = 0;
    INACTIVE = 1;
    MAINTENANCE = 2;
    ERROR = 3;
    OVERLOADED = 4;
  }
}

message DistributedTask {
  string task_id = 1;
  TaskType task_type = 2;
  string assigned_node = 3;
  TaskStatus status = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp started_at = 6;
  google.protobuf.Timestamp completed_at = 7;
  google.protobuf.Any task_payload = 8;
  google.protobuf.Any task_result = 9;

  enum TaskType {
    PACKET_CAPTURE = 0;
    FEATURE_EXTRACTION = 1;
    ML_INFERENCE = 2;
    GEOIP_ENRICHMENT = 3;
    THREAT_ANALYSIS = 4;
    DATA_AGGREGATION = 5;
    ALERT_GENERATION = 6;
  }

  enum TaskStatus {
    PENDING = 0;
    RUNNING = 1;
    COMPLETED = 2;
    FAILED = 3;
    CANCELLED = 4;
  }
}

// =====================================================================
// COMPRESSION & ENCRYPTION - Optimización de Red
// =====================================================================

message CompressionMetadata {
  CompressionAlgorithm algorithm = 1;
  uint64 original_size = 2;
  uint64 compressed_size = 3;
  double compression_ratio = 4;
  google.protobuf.Duration compression_time = 5;

  enum CompressionAlgorithm {
    NONE = 0;
    GZIP = 1;
    LZ4 = 2;
    ZSTD = 3;
    SNAPPY = 4;
    BROTLI = 5;
  }
}

message EncryptionMetadata {
  EncryptionAlgorithm algorithm = 1;
  string key_id = 2;
  bytes initialization_vector = 3;
  google.protobuf.Duration encryption_time = 4;

  enum EncryptionAlgorithm {
    NONE = 0;
    AES_256_GCM = 1;
    CHACHA20_POLY1305 = 2;
    AES_256_CBC = 3;
  }
}

// =====================================================================
// RAG & HUMAN-IN-THE-LOOP - Sistemas Inteligentes
// =====================================================================

message RAGContext {
  string query = 1;
  repeated string retrieved_documents = 2;
  repeated double relevance_scores = 3;
  string generated_response = 4;
  double confidence = 5;
  repeated string source_references = 6;
  google.protobuf.Timestamp generated_at = 7;
}

message HumanFeedback {
  string feedback_id = 1;
  string user_id = 2;
  string alert_id = 3;
  FeedbackType feedback_type = 4;
  bool is_true_positive = 5;
  string explanation = 6;
  repeated string tags = 7;
  google.protobuf.Timestamp provided_at = 8;

  enum FeedbackType {
    VALIDATION = 0;
    CORRECTION = 1;
    ENHANCEMENT = 2;
    FALSE_POSITIVE = 3;
    ADDITIONAL_INFO = 4;
  }
}

message HumanInTheLoop {
  bool requires_human_review = 1;
  string review_priority = 2; // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  repeated string review_reasons = 3;
  HumanFeedback feedback = 4;
  google.protobuf.Timestamp escalated_at = 5;
  google.protobuf.Timestamp reviewed_at = 6;
}

// =====================================================================
// MAIN MESSAGE - Estructura Principal Unificada
// =====================================================================

message NetworkSecurityEvent {
  // IDENTIFICACIÓN ÚNICA
  string event_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  string source_node = 3;

  // DATOS CORE
  NetworkFeatures features = 4;
  GeoEnrichment geo_enrichment = 5;
  TimeWindow time_window = 6;

  // ANÁLISIS ML
  TricapaAnalysis tricapa_analysis = 7;
  repeated ModelPrediction additional_predictions = 8;

  // SISTEMA DISTRIBUIDO
  NodeInfo capturing_node = 9;
  repeated DistributedTask related_tasks = 10;

  // OPTIMIZACIÓN
  CompressionMetadata compression = 11;
  EncryptionMetadata encryption = 12;

  // INTELIGENCIA AUMENTADA
  RAGContext rag_context = 13;
  HumanInTheLoop human_interaction = 14;

  // METADATOS
  uint32 schema_version = 15; // 31 para v3.1
  map<string, string> custom_metadata = 16;
  repeated string tags = 17;
  double overall_threat_score = 18;

  // TRAZABILIDAD
  string correlation_id = 19;
  repeated string parent_event_ids = 20;
  repeated string child_event_ids = 21;
}

// =====================================================================
// STREAMING & BATCH PROCESSING - Procesamiento
// =====================================================================

message StreamingBatch {
  repeated NetworkSecurityEvent events = 1;
  uint64 batch_id = 2;
  google.protobuf.Timestamp batch_timestamp = 3;
  uint32 batch_size = 4;
  ProcessingMode processing_mode = 5;

  enum ProcessingMode {
    REAL_TIME = 0;
    NEAR_REAL_TIME = 1;
    BATCH = 2;
    HISTORICAL = 3;
  }
}

// =====================================================================
// CONFIGURATION - Configuración del Sistema
// =====================================================================

message SystemConfiguration {
  // Configuración de modelos ML
  repeated string enabled_models = 1;
  map<string, double> model_thresholds = 2;

  // Configuración de tiempo
  google.protobuf.Duration time_window_size = 3;
  uint32 max_flows_per_window = 4;

  // Configuración distribuida
  repeated NodeInfo available_nodes = 5;
  map<string, string> node_assignments = 6;

  // Configuración de seguridad
  bool encryption_enabled = 7;
  bool compression_enabled = 8;
  string encryption_key_id = 9;

  // Configuración RAG
  bool rag_enabled = 10;
  string rag_model_endpoint = 11;
  repeated string knowledge_sources = 12;
}